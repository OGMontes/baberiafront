<div class="citas-container">

  <!-- Encabezado con mes y navegaci√≥n -->
  <div class="calendario-header">
    <button (click)="mesAnterior()">‚Üê</button>
    <h2>{{ mesActual | date: 'MMMM yyyy' }}</h2>
    <button (click)="mesSiguiente()">‚Üí</button>
  </div>

  <!-- D√≠as de la semana -->
  <div class="dias-semana">
    <div *ngFor="let dia of diasSemana" class="dia-semana">
      {{ dia }}
    </div>
  </div>

  <!-- Matriz del calendario -->
  <div class="calendario-grid">
    <div
      *ngFor="let dia of semanas.flat()"
      class="dia-celda"
      [ngClass]="{ 'hoy': esHoy(dia.fecha), 'fuera-mes': !dia.enMesActual }"
      (click)="abrirDia(dia)">
      
      <div class="numero-dia">{{ dia.fecha.getDate() }}</div>

      <!-- Primeras 5 citas -->
      <div
        *ngFor="let cita of dia.citas.slice(0, 5)"
        class="cita-resumen"
        [ngClass]="cita.Estado?.toLowerCase()"
        (click)="abrirModal(cita, $event)"
        [title]="'Servicio: ' + getNombreServicio(cita.ServicioId) + ' - Barbero: ' + getNombreBarbero(cita.BarberoId)">
        <span class="hora">{{ cita.FechaCita | date:'shortTime' }}</span>
        <span class="cliente">{{ cita.NombreCliente }}</span>
      </div>

      <!-- Bot√≥n "ver m√°s" si hay m√°s citas -->
      <div *ngIf="dia.citas.length > 5" class="ver-mas" (click)="abrirModalCitasDia(dia)">
        + ver m√°s
      </div>
    </div>
  </div>

  <!-- Modal de cita -->
  <div class="modal-cita" *ngIf="citaSeleccionada">
    <div class="modal-contenido">
      <h3 *ngIf="citaSeleccionada.CitaId; else nuevaCita">
        Editar cita
      </h3>
      <ng-template #nuevaCita>
        <h3>Agendar nueva cita</h3>
      </ng-template>

      <form (ngSubmit)="guardarCita()" #formCita="ngForm">
        <p><strong>Fecha:</strong> {{ citaSeleccionada.fecha | date:'fullDate' }}</p>

        <label>Hora:</label>
        <input type="time" [(ngModel)]="citaSeleccionada.hora" name="hora" required />

        <label>Nombre:</label>
        <input type="text" [(ngModel)]="citaSeleccionada.NombreCliente" name="NombreCliente" required />

        <label>Servicio:</label>
        <select [(ngModel)]="citaSeleccionada.ServicioId" name="ServicioId" required>
          <option value="">Seleccionar</option>
          <option *ngFor="let s of servicios" [value]="s.ServicioId">{{ s.Nombre }}</option>
        </select>

        <label>Barbero:</label>
        <select [(ngModel)]="citaSeleccionada.BarberoId" name="BarberoId" required>
          <option value="">Seleccionar</option>
          <option *ngFor="let b of barberos" [value]="b.BarberoId">{{ b.Nombre }}</option>
        </select>

        <label>Comentarios:</label>
        <textarea [(ngModel)]="citaSeleccionada.Comentarios" name="Comentarios" rows="2"></textarea>

        <div class="acciones-modal">
          <button type="submit">Guardar</button>
          <button *ngIf="citaSeleccionada.CitaId" class="cancelar" (click)="cancelarCita()">Cancelar</button>
          <button *ngIf="citaSeleccionada.Estado === 'Pendiente'" class="confirmar" (click)="confirmarCita()">Confirmar</button>
          <button class="cerrar" type="button" (click)="cerrarModal()">Cerrar</button>
        </div>
      </form>
    </div>
  </div>

<!-- Modal "ver m√°s" funcional -->
<div class="modal-citas-dia" *ngIf="diaSeleccionado">
  <div class="modal-contenido extendida-scroll">
    <div style="display: flex; justify-content: space-between; align-items: center;">
<div style="display: flex; justify-content: space-between; align-items: center;">
  <h3>Citas del {{ diaSeleccionado.fecha | date:'fullDate' }}</h3>
  <button (click)="cerrarModalDia()" class="cerrar-boton">‚úñ</button>
</div>
      <button (click)="cerrarModalDia()" class="cerrar-boton">‚úñ</button>
    </div>

    <div *ngFor="let cita of diaSeleccionado.citas" class="cita-item extendida">
      
      <!-- Si est√° en modo edici√≥n -->
      <ng-container *ngIf="cita.editando; else verCita">
        <strong>{{ cita.FechaCita | date:'shortTime' }}</strong> ‚Äì 
        <input type="text" [(ngModel)]="cita.NombreCliente" placeholder="Cliente" />
        <select [(ngModel)]="cita.ServicioId">
          <option *ngFor="let s of servicios" [value]="s.ServicioId">{{ s.Nombre }}</option>
        </select>
        <select [(ngModel)]="cita.BarberoId">
          <option *ngFor="let b of barberos" [value]="b.BarberoId">{{ b.Nombre }}</option>
        </select>
        <textarea [(ngModel)]="cita.Comentarios" placeholder="Comentarios" rows="2"></textarea>

        <div class="acciones">
          <button (click)="guardarCitaEditada(cita)">üíæ Guardar</button>
          <button (click)="cita.editando = false">‚ùå Cancelar</button>
        </div>
      </ng-container>

      <!-- Vista normal -->
      <ng-template #verCita>
        <strong>{{ cita.FechaCita | date:'shortTime' }}</strong> ‚Äì 
        <span>{{ cita.NombreCliente }}</span><br>
        <small>Servicio: {{ getNombreServicio(cita.ServicioId) }}</small><br>
        <small>Barbero: {{ getNombreBarbero(cita.BarberoId) }}</small><br>
        <small>Estado: 
          <span [ngClass]="{
            'text-confirmada': cita.Estado === 'Confirmada',
            'text-pendiente': cita.Estado === 'Pendiente',
            'text-cancelada': cita.Estado === 'Cancelada'
          }">{{ cita.Estado }}</span>
        </small><br>
        <small *ngIf="cita.Comentarios">üìù {{ cita.Comentarios }}</small><br>

        <div class="acciones">
          <button (click)="cita.editando = true">‚úèÔ∏è Editar</button>
          <button *ngIf="cita.Estado === 'Pendiente'" (click)="confirmarCitaDesdeLista(cita)">‚úÖ Confirmar</button>
          <button (click)="cancelarCitaDesdeLista(cita)">‚ùå Cancelar</button>
        </div>
      </ng-template>
    </div>
  </div>
</div>




  <!-- Toast -->
  <div class="toast" *ngIf="mostrarToastActivo">
    {{ toastMensaje }}
  </div>

</div>
